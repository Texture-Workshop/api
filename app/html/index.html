<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="An index for Geometry Dash Texture Packs">
    <meta name="keywords" content="Geometry Dash, Texture Pack, Texture Workshop, Geode, Uproxide">
    <link rel="stylesheet" href="/css/tws.css">
    <link rel="stylesheet" href="/css/twsIndex.css">
    <title>Texture Workshop</title>
</head>
<body>
	<span class="background"></span>
	<div class="position-box">
		<div class="logo-div">
			<img class="logo" src="/assets/TWS_Logo.png"></img>
			<img class="workshop" src="/assets/TWS_Workshop.png"></img>
		</div>
		<span class="container-border"></span>
		<div id="packsContainer" class="loading">
			<div class="search-bar-div">
				<input type="text" id="searchBar" class="search-bar" placeholder="Search">
				<button onclick="document.getElementById('sort').click();" class="search-bar-button">
					<img width="30px" src="/assets/filter.svg"></img>
				</button>
				<select class="sort" id="sort">
					<option value="">Default</option>
					<option value="downloads">Most Downloads</option>
					<option value="recent">Recently Updated</option>
					<option value="featured">Featured</option>
				</select>
			</div>
			
			<div id="texturePackList" class="texture-pack-list"></div>
			
			<div id="texturePackLoading" class="texture-pack-loading">
					<p>Loading...</p>
			</div>
		</div>
	</div>

    <script>
        const packsContainer = document.getElementById("packsContainer");
        const texturePackList = document.getElementById("texturePackList");
        const sortSelect = document.getElementById("sort");
        const searchBar = document.getElementById("searchBar");
		var x = 0;

        let allTexturePacks = [];

        // Function to fetch texture packs and handle the response
        function fetchTexturePacks(sort = "") {
            packsContainer.classList.add('loading');

            fetch(`/api/v1/tws/getTPs?sort=${sort}`)
                .then(response => response.json())
                .then(data => {
                    texturePackList.innerHTML = ""; // Clear "Loading texture packs..."

                    if (data && Array.isArray(data.packs)) {
                        allTexturePacks = data.packs;
                        displayTexturePacks(allTexturePacks);
                    }  else if (data && Array.isArray(data)) {
                        allTexturePacks = data;
                        displayTexturePacks(allTexturePacks);
                    } else if (data && typeof data === "object") {
                        allTexturePacks = Object.values(data);
                        displayTexturePacks(allTexturePacks);
                    } else {
                        texturePackList.innerHTML = "<p>No texture packs found.</p>";
						packsContainer.classList.remove('loading');
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    texturePackList.innerHTML = "<p>Error fetching texture packs. Please try again later.</p>";
					packsContainer.classList.remove('loading');
                });
        }

        // Function to display texture packs
        function displayTexturePacks(packs) {
			x = 0;
            packs.forEach(pack => {
                const packElement = document.createElement("div");
                packElement.classList.add("texture-pack");
				if(!(x % 2)) packElement.classList.add("darker");
				
				const packImageDiv = document.createElement("div");
				packImageDiv.classList.add("texture-pack-logo-div");
				
                const packImage = document.createElement("img");
                packImage.src = pack.packLogo;
                packImage.alt = `${pack.packName} Logo`;
				
                const packFeaturedImage = document.createElement("img");
                packFeaturedImage.src = '/assets/TWS_Featured.png';
                packFeaturedImage.alt = `${pack.packName} is featured!`;
                packFeaturedImage.classList.add('featured');

                const packDetails = document.createElement("div");
                packDetails.classList.add("pack-details");
                packDetails.innerHTML = `
                    <h2>${pack.packName} (${pack.packID})<span>by ${pack.packCreator}</span></h2>
                    <p>${pack.packDescription}</p>
                `;

                const packMeta = document.createElement("div");
                packMeta.classList.add("pack-meta");
                packMeta.innerHTML = `
                    <p>TP Version: <span>${pack.packVersion}</span></p>
                    <p>GD Version: <span>${pack.gdVersion}</span></p>
                    <p>Downloads: <span>${pack.packDownloads}</span></p>
                    <a href="${pack.downloadLink}" download>Download</a>
                `;
				
                packImageDiv.appendChild(packImage);
				if(pack.packFeature) packImageDiv.appendChild(packFeaturedImage);
                packElement.appendChild(packImageDiv);
                packElement.appendChild(packDetails);
                packElement.appendChild(packMeta);

                texturePackList.appendChild(packElement);
				x++;
            });
			packsContainer.classList.remove('loading');
        }

        searchBar.addEventListener("input", function() {
			packsContainer.classList.add('loading');
            const query = searchBar.value.toLowerCase();
            const filteredPacks = allTexturePacks.filter(pack => 
                pack.packName.toLowerCase().includes(query) || 
                pack.packDescription.toLowerCase().includes(query)
            );
            texturePackList.innerHTML = "";
            displayTexturePacks(filteredPacks);
        });

        sortSelect.addEventListener("change", function() {
            fetchTexturePacks(this.value);
        });

        fetchTexturePacks();
    </script>
</body>
</html>
